# ADR-0002: Firebaseを主要バックエンドとして採用し、Supabaseを移行候補とする戦略

**ステータス:** 決定済み
**日付:** 2025-07-26

## 1. コンテキスト

本アプリケーションは、初期段階ではクライアント完結型だが、将来のサービス拡大（マルチデバイス、データ同期、複数人利用）を見据え、スケーラブルでセキュアなバックエンドアーキテクチャを定義する必要がある。最優先事項は「市場投入までの開発速度」としつつ、長期的なリスクも管理する。

**主要要件:**
- **データ同期とオフラインサポート:** 複数デバイス間でデータが同期でき、オフラインでも利用可能であること。
- **堅牢な認証・認可:** 複数ユーザーが安全に利用でき、他人のデータへのアクセスは厳格に禁止されること。
- **データのポータビリティ:** ユーザーが自身のデータをMarkdown形式（添付ファイル含む）で自由にインポート/エクスポートできること。

## 2. 決定

1.  **主要バックエンドとして Firebase を採用する。**
2.  **将来の移行先候補として Supabase を位置づける**ことで、ベンダーロックインのリスクを管理する。
3.  **移行コストを最小化するため、開発当初からバックエンド処理の抽象化を徹底する。**

## 3. アーキテクチャ詳細

### 3.1. 採用技術スタック

- **クラウドプロバイダー:** **Firebase (Google Cloud)**
- **認証:** **Firebase Authentication**
- **データベース:** **Cloud Firestore**
- **ファイルストレージ:** **Cloud Storage for Firebase**
- **サーバーレス関数:** **Cloud Functions for Firebase**
- **主要OSSライブラリ:**
    - **状態管理:** `TanStack Query` (非同期データ管理)
    - **Markdown処理:** `react-markdown` (レンダリング), `gray-matter` (メタデータ解析)
    - **ファイル処理:** `JSZip` (Zip生成), `FileSaver.js` (ダウンロード)

### 3.2. 認証・認可モデル

- **認証 (Authentication):**
    - **Firebase Authentication** を全面的に利用し、メール/パスワード、Google/Appleなどのソーシャルログインを提供する。
    - 認証成功後、クライアントはユーザーの一意な **UID** と **IDトークン (JWT)** を受け取る。

- **認可 (Authorization):**
    - **FirestoreとCloud Storageのセキュリティルール** を認可の核とする。
    - **基本原則:** 「リクエストに含まれるIDトークンのUID (`request.auth.uid`) が、アクセス対象のデータのパスに含まれるUID (`userId`) と一致すること」を全ルールの基本条件とする。
    - **実装例 (Firestore):**
      ```
      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {
          match /users/{userId}/{documents=**} {
            allow read, write: if request.auth.uid == userId;
          }
        }
      }
      ```

### 3.3. データ構造とMarkdownインポート/エクスポート仕様

- **データ構造:** メタデータとコンテンツを分離し、クエリ効率を向上させる。
- **インポート/エクスポート形式:** **Zipアーカイブ**を採用。
    - **構成:** `memos/`, `tasks/` ディレクトリにMarkdownファイルを格納し、`attachments/` に画像ファイルを格納する。
    - **Markdownファイル:** メタデータを **YAML Frontmatter** 形式でファイル先頭に記述する。
- **添付ファイル:**
    - **Cloud Storage** のユーザー専用パス (`/users/{userId}/attachments/`) に画像をアップロードする。
    - エクスポート時には、画像ファイルをZipに同梱し、Markdown内のパスを相対パスに変換する。

## 4. 根拠

- **Firebase採用の根拠:** 開発速度、運用負荷の低減、スケーラビリティ。
- **Supabaseを移行候補とする根拠:** ベンダーロックインのリスクヘッジ、OSSであることによる永続性の確保。
- **OSSライブラリ採用の根拠:** 状態管理やMarkdown処理などの複雑な実装を効率化し、堅牢性を高めるため。

## 5. 結果とコンティンジェンシープラン

### 5.1. 結果

- **メリット:** 開発速度を最大化しつつ、明確な出口戦略を持つことで安心して開発にコミットできる。
- **デメリット:** 将来移行が発生した場合、相応の移行コストがかかる。

### 5.2. コンティンジェンシープラン（移行戦略）

- **発動条件:** Firebaseのサービス終了告知、または事業継続に影響する大幅な料金改定。
- **移行先:** **Supabase** を第一候補としつつ、発動時点での最適解を再評価する。
- **必須の備え:** **バックエンド処理の抽象化（リポジトリパターン）**を徹底し、移行時のコード修正範囲を最小限に留める。

## 6. 検討した他の選択肢

- **最初からSupabaseを利用する:** 開発速度の観点から、現時点ではFirebaseの方がドキュメントの豊富さやコミュニティの成熟度でわずかに上回り、初期開発速度がより速いと判断した。
- **AWS Amplify:** AWSエコシステムとの連携は強力だが、本プロジェクトの要件に対してはFirebaseの方がシンプルで迅速と判断。
- **フルOSSでの自前構築:** 開発・運用コストが過大であり、プロジェクトの優先事項と合致しないため除外した。
