# Builder緊急実装指示書 - Phase 2.2d拡張（データ保護・モバイルUX致命問題解決）

## 対象エージェント: Builder
## 実装モード: TDD + 緊急修正
## 優先度: 最高（製品価値に直結する致命的問題）

---

## 🚨 緊急事態の背景

プロダクトオーナーの実機確認により、**データ損失**と**基本機能破綻**の致命的問題が発見されました：

1. **モバイル日付設定バグ**: 7/25開始時に7/24表示（UTC/JST問題）
2. **タスクメモ保存完全失敗**: モバイルでメモが一切保存されない  
3. **品質ゲート信頼性低下**: CSSクラス検証の誤検出多発

これらの修正なしに、次期フォーカスモード強化は無意味です。

---

## 🎯 実装指示

詳細な技術仕様は以下を参照：
📋 **設計書**: @docs/design/phase-2-2d-emergency-expansion.md

### 実装概要

**目標**: データ保護機能とモバイル基本動作の確実な実現
**期間**: 2-3日（当初計画から拡張）
**完了条件**: プロダクトオーナー実機確認で4つの致命問題完全解決

---

## 🔴 最高優先度タスク（即時着手）

### T006: モバイル日付設定バグ修正
```typescript
// 問題: UTC/JST時差、「今日」ボタン状態異常
// 解決: JST基準日付計算・状態管理修正
// 期間: 1日
// 影響: 基本機能の信頼性、日本市場適合性
```

### T007: モバイルタスクメモ保存機能実装  
```typescript
// 問題: タスクメモが保存されない（データ損失リスク）
// 解決: 3秒自動保存 + 戻るボタン保存
// 期間: 1-2日
// 影響: ユーザーデータ保護、製品価値の根幹
```

### T008: CSSクラス検証スクリプト改善
```bash
# 問題: 複合セレクタ誤検出（nav-large等）
# 解決: 検出ロジック改善
# 期間: 0.5日
# 影響: 品質ゲートの信頼性
```

---

## 🔴 重要な実装要件

### TDD厳守（緊急時でも妥協禁止）
- **Red**: 失敗テスト作成（UTC/JST、自動保存、手動保存）
- **Green**: 最小限実装（データ保護最優先）
- **Blue**: 品質向上（エラーハンドリング、UX改善）

### 技術制約
- **Design Philosophy完全遵守**: 統一性維持
- **既存テスト保護**: 266/271テスト成功率維持必須
- **プロダクション品質**: ビルド成功・TypeScript・ESLintクリア

### データ保護要件
- **確実な保存**: LocalStorage書き込み成功保証
- **エラー処理**: 保存失敗時の適切なフィードバック
- **ユーザー体験**: 保存状態の視覚的確認

---

## 🎯 完成の定義（DoD）

### 機能要件
- [ ] モバイルで正確な今日日付がJST基準で表示される
- [ ] 「今日」ボタンの選択状態が正常に動作する  
- [ ] タスクメモが3秒自動保存される（モバイル）
- [ ] 戻るボタンでタスクメモが手動保存される
- [ ] CSSクラス検証が複合セレクタを正常検出する

### 品質要件  
- [ ] 新規テスト15+ケース全通過
- [ ] 既存266/271テスト成功率維持
- [ ] プロダクションビルド成功
- [ ] TypeScript・ESLintエラーなし

### 実機確認要件（最重要）
- [ ] **プロダクトオーナー実機確認**: 4つの致命問題が完全解決
- [ ] **モバイル・デスクトップ両方**: 全機能正常動作
- [ ] **データ保護確認**: メモ保存・読み込みの完全動作

---

## 🚀 推奨実装順序

### Day 1: T006 日付バグ緊急修正
1. **Red Phase**: JST日付・今日判定・状態管理テスト
2. **Green Phase**: dateUtilsモジュール・DateNavigation修正
3. **Blue Phase**: エラーハンドリング・エッジケース対応

### Day 2: T007 タスクメモ保存実装
1. **Red Phase**: 自動保存・手動保存・エラー処理テスト
2. **Green Phase**: useAutoSaveフック・TaskMemo統合
3. **Blue Phase**: 保存フィードバックUI・UX改善

### Day 3: T008 + 全体仕上げ
1. **Morning**: CSSクラス検証スクリプト改善
2. **Afternoon**: 全体品質確認・実機テスト
3. **Evening**: プロダクションビルド・Phase 2.2d完了

---

## 🎖️ 期待される成果

### 製品価値の回復
- **データ保護**: ユーザーの情報資産を確実に保護
- **基本信頼性**: 日付表示・操作の正確性保証
- **品質基盤**: 自動化ツールの信頼性向上

### 戦略的価値  
- **Phase 2.2b準備**: フォーカスモード強化への確実な基盤
- **ユーザー信頼**: 致命的バグ解決によるプロダクト信頼性向上
- **開発効率**: 品質ゲート改善による持続可能な開発体制

### 技術的価値
- **モバイル最適化**: タッチデバイスでの完全動作保証
- **時差対応**: 日本市場での正確な日付処理
- **エラー処理**: 予期しない状況への堅牢な対応

---

## 💬 Plannerからのメッセージ

お疲れさまです。Phase 2.2aの素晴らしい実装により、Today-First UXが実現されました。

しかし、プロダクトオーナーの実機確認で発見された致命的問題は、Focus-Flowの製品価値そのものを脅かします。特にデータ損失は、ユーザーの信頼を根本的に失う重大事故です。

この緊急修正は、次の革新的フォーカスモード強化への確実な基盤作りでもあります。データ保護と基本機能の信頼性を確保して、Focus-Flowを真に価値ある製品に育て上げましょう。

技術的には複雑ではありませんが、確実性が最優先です。TDD手法により、一つずつ着実に問題を解決していけば必ず成功するでしょう。

応援していますね！

---

*2025-07-25 Planner Agent - Phase 2.2d 緊急拡張実装指示*
*データ保護・モバイルUX致命問題の完全解決を目指して*