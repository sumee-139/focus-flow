# Vibe Coding 2.0: ローカル品質ゲートを導入した開発ワークフロー改善計画

## 1. はじめに

本ドキュメントは、Vibe Codingの高速な開発サイクルを維持しつつ、技術的負債を計画的に返済するための新しいワークフロー「Vibe Coding 2.0」を提案するものです。

GitHub Actionsなどの外部CI/CDサービスに依存せず、ローカル環境で完結する**「品質ゲート」**を導入することで、AIエージェント（Claude Code）を単なる実装者から**「品質保証のパートナー」**へと役割を進化させます。

## 2. コアコンセプト：AIのための「品質の法律」

このワークフローの核心は、AIに越えるべき明確な品質基準をコードで示すことです。具体的には、`local-ci-check.sh`というシェルスクリプトを作成し、これを**「AIが遵守すべき法律」**とします。

AIの責務は**「このスクリプトをパスするコードを書くこと」**に集約され、開発者は品質チェックの自動化によって、より創造的な対話に集中できます。

## 3. Phase 0: 基盤整備フェーズ（即日実施）

**目的：** これ以上の負債の積み上がりを止め、AIが越えるべき「品質の壁」をコードで定義する。

### アクション1: ローカルCIスクリプトの作成

`focus-flow-capacitor` プロジェクトの品質を担保するため、以下の4つのチェックを順番に実行する `local-ci-check.sh` を `.claude/scripts/` に配置しました。

1.  **静的解析 (ESLint)**: コードスタイルと潜在的なバグをチェック
2.  **単体・結合テスト (Vitest)**: 個々の機能のロジックを検証
3.  **E2Eテスト (Playwright)**: ユーザー視点での操作フローを保証
4.  **プロダクションビルド**: アプリケーションが正常にビルドできることを確認

このスクリプトは、どれか一つでも失敗すると処理を中断し、エラーを報告します。

```bash
#!/bin/bash
# ローカル環境でCI/CDを模倣する品質ゲートスクリプト

# スクリプトが配置されているディレクトリに移動して実行
cd "$(dirname "$0")"/../../focus-flow-capacitor"

# ... (スクリプト本体) ...

echo -e "${YELLOW}===== ローカル品質ゲート開始 =====${NC}"

# 1. 静的解析 (ESLint)
# ...

# 2. 単体・結合テスト (Vitest)
# ...

# 3. E2Eテスト (Playwright)
# ...

# 4. プロダクションビルド
# ...

echo -e "\n${GREEN}===== すべての品質ゲートをクリアしました！ =====${NC}"

exit 0
```

### アクション2: 実行権限の付与

作成したスクリプトには、`chmod +x` コマンドによって実行権限が付与済みです。

---

## 4. Phase 1: 負債返済集中フェーズ（スプリント1〜2回）

**目的：** 作成した品質ゲートを活用し、最大の負債である「アーキテクチャの不統一」を安全に解消する。

### ステップ1: Plannerによる段階的移行計画の策定

まず、Plannerエージェントに既存のドキュメントを読み込ませ、具体的な移行計画を策定させます。

-   **プロンプト例**:
    ```
    /agent:planner
    ADR-0001と技術的負債レポートに基づき、Electronの機能を一つずつCapacitorに移行するための詳細なタスクリストを作成し、phase-todo.mdを更新してください。最初のステップは「Capacitorでのデスクトップビルド成功」です。
    ```

### ステップ2: Builderによる「品質ゲート駆動」開発

次に、Builderエージェントに計画を一つずつ実行させます。作業の完了は、ローカルCIスクリプトの成功をもって判断します。

-   **プロンプト例**:
    ```
    /agent:builder
    phase-todo.mdの次のタスク「メニューバー機能の移行」を実施してください。実装後、必ず '/.claude/scripts/local-ci-check.sh' を実行して、結果が成功することを確認してください。
    ```

---

## 5. Phase 2: 新・Vibe Codingワークフローの定着

**目的：** ローカル品質ゲートを開発サイクルに完全に定着させ、負債の再発を防ぐ。

### 1. 「完了の定義」を更新し、AIに徹底させる

Builderエージェントの `identity.md` やプロンプトに、新しい「完了の定義」を明記します。

-   **新しい完了の定義**:
    1.  コードが実装されていること。
    2.  単体テストが書かれていること。
    3.  **`/.claude/scripts/local-ci-check.sh` がエラーなく成功すること。**
    4.  関連ドキュメントが更新されていること。

### 2. TDD（テスト駆動開発）とローカルCIを組み合わせる

機能開発の依頼方法を「テスト先行」にし、最終確認をローカルCIに委ねます。

-   **プロンプト例**:
    ```
    /agent:builder
    新しい「繰り返しタスク」機能を追加します。まず、この機能が失敗することを証明するVitestの単体テストを書いてください。テストが書けたら、機能本体を実装し、最後に '/.claude/scripts/local-ci-check.sh' を実行して全てがパスすることを確認してください。
    ```

### 3. 「技術的負債返済デー」の導入

週に一度など、定期的に技術的負債の返済タスクをPlannerに選定させ、Builderに実行させます。この際も、作業の完了は `local-ci-check.sh` の成功をもって判断します。

## 6. まとめ

このアプローチにより、**「AIは、ローカルCIスクリプトという"法律"の範囲内で、最大限の創造性を発揮する」**という、自律的かつ規律ある開発体制を構築できます。

-   **明確なゴール**: AIにとって「良いコード」の基準が明確になります。
-   **速度の維持**: 開発者はAIとの対話に集中でき、品質チェックはスクリプトが機械的に行います。
-   **安全なリファクタリング**: 負債返済のような危険な作業も、スクリプトがデグレードを検知する安全網として機能します。

これにより、外部サービスに依存せずとも、Vibe Codingの高速な開発サイクルの中に、堅牢な品質保証の仕組みを組み込むことが可能になります.
